<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>

    <style>
        path {
          stroke: #000000;
          stroke-width: 0.25px;
          fill: gray;
        }

        .states {
          fill: none;
          stroke: #fff;
          stroke-linejoin: round;
        }

        .subunit-label {
          fill: #777;
          fill-opacity: .5;
          font-size: 20px;
          font-weight: 300;
          text-anchor: middle;
        }

        .active {
          fill: #DE2D26;
        }
    </style>

    <!-- D3 Libraries -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js" charset="utf-8"></script>

  </head>
  <body>

    <div id="map"></div>

    <script type="text/javascript">

      var width = 960,
          height = 1160;

      var active;

      /*
      var projection = d3.geo.mercator()
          .center([0,0])
          .scale(85)
          .rotate([0, 0]);
      */

      var projection = d3.geo.albers()
            .center([0, 43.5])
            .rotate([71.5, 0])
            .parallels([50, 60])
            .scale(15000)
            .translate([width / 2, height / 2]);

      var pathMap = d3.geo.path()
          .projection(projection);

      var svgMap = d3.select("#map").append("svg")
          .attr("width", widthMap)
          .attr("height", heightMap);

      svgMap.append("rect")
        .attr("width", widthMap)
        .attr("height", heightMap)
        .attr("id", "mapbg")
        .on("click", reset);


      var gMap = svgMap.append("g")
          .attr("transform", "translate(-190,0)");


      // function to zoom in on a country in the map by user click
      function click(d) {

        // if already active clicking will de-activate
        if (active === d) return reset();
          
        // clicking a second country while zoomed in will de-activate (un-highlight) the first
        gMap.selectAll(".active").classed("active", false);

        // highlights (fills) the country clicked
        d3.select(this).classed("active", active = d);

        var centroid = pathMap.centroid(d);
        var x = centroid[0];
        var y = centroid[1];
        var k = 4;

        gMap.transition()
            .duration(1000)
            .attr("transform", "translate(" + widthMap / 2 + "," + heightMap / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
            .style("stroke-width", 1.5 / k + "px");
     
      }


      // zooms the map back out
      function reset() {
        gMap.selectAll(".active").classed("active", active = false);
        gMap.transition().duration(750).attr("transform", "translate(-190,0)");
        gMap.selectAll(".country")
            .transition()
              .duration(750)
            .style("stroke-width", ".5px");
      }


      var tooltip = d3.select("#map").append("div")
        .attr("class", "tooltip");

      // use queue for the map data files
      queue()
          .defer(d3.json, "data/world-110m.json")
          .defer(d3.tsv, "data/world-country-names.tsv")
          .await(ready);



      function ready(error, world, names) {

        var countries = topojson.object(world, world.objects.countries).geometries,
            neighbors = topojson.neighbors(world, countries),
            i = -1,
            n = countries.length;

        countries.forEach(function(d) { 
          var tryit = names.filter(function(n) { return d.id == n.id; })[0];
          if (typeof tryit === "undefined"){
            d.name = "Undefined";
          } 
          else {
            d.name = tryit.name; 
          }
        });

        var country = gMap.selectAll(".country").data(countries);

        country
         .enter()
          .insert("path")
          .attr("class", function(d,i) { return d.name + " country"; })   
            .attr("title", function(d,i) { return d.name; })  // country name
            .attr("d", pathMap)
            .on("click", click);

          //Show/hide tooltip
          country
            .on("mousemove", function(d,i) {
              var mouse = d3.mouse(svgMap.node()).map( function(d) { return parseInt(d); } );

              tooltip
                .classed("hidden", false)
                .attr("style", "left:" + (mouse[0]+670) + "px;top:" + (mouse[1]+60) + "px")
                .html(d.name)
            })
            .on("mouseout",  function(d,i) {
              tooltip.classed("hidden", true)
            });

      }