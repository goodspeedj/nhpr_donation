<!DOCTYPE html>
<html>
 <head>
   <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>

   <style>

        #mapbg {
          fill: none;
          pointer-events: all;
        }

       path {
         stroke: #000000;
         stroke-width: 0.25px;
         fill: gray;
       }

       .states {
         fill: none;
         stroke: #fff;
         stroke-linejoin: round;
       }

       .subunit-label {
         fill: #777;
         fill-opacity: .5;
         font-size: 20px;
         font-weight: 300;
         text-anchor: middle;
       }

       div.tooltip {
        color: #222; 
        font-size: 11px;
        font-family: sans-serif;
        background: #fff; 
        padding: .5em; 
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px; 
        box-shadow: 0px 0px 2px 0px #a6a6a6; 
        opacity: .86; 
        position: absolute;
      }

      .town {
        fill: #ccc;
        stroke: gray;
        stroke-width: .5px;
        stroke-linejoin: round;
        cursor: pointer;
      }

      .hidden { 
        display: none; 
      }

      .active {
        fill: #DE2D26;
      }

      .boundary {
        fill: none;
        stroke: #424242;
        stroke-width: 1px;
      }

   </style>

   <!-- D3 Libraries -->
   <script src="js/d3.v3.min.js" charset="utf-8"></script>
   <script src="js/queue.v1.min.js" charset="utf-8"></script>
   <script src="js/topojson.v1.min.js" charset="utf-8"></script>

 </head>
 <body>

   <div id="map"></div>

   <script type="text/javascript">
       

        var width = 550;
        var height = 770;
        //var width = 1000;
        //var height = 2000;
        var active;

        var tooltip = d3.select("#map").append("div")
            .attr("class", "tooltip");

        var fill = d3.scale.log()
            .domain([10, 500])
            .range(["white", "#006600"]);


        var color = d3.scale.threshold()
            .domain([0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000])
            .range(["#FFFFFF", "#F7FCFD", "#E5F5F9", "#CCECE6", "#99D8C9", "#66C2A4", "#41AE76", "#238B45", "#006D2C", "#00441B", "#002900"]);


        var projection = d3.geo.albers()
            .center([0, 43.9])
            .rotate([71.5, 0])
            .parallels([50, 60])
            .scale(15000)
            .translate([width / 2, height / 2]);

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height);

        svg.append("rect")
          .attr("width", width)
          .attr("height", height)
          .attr("id", "mapbg")
          .on("click", reset);

        var g = svg.append("g");
        var g_ma = g.append("g");
        var g_me = g.append("g");
        var g_nh = g.append("g");
        var g_vt = g.append("g");


        // function to zoom in on a country in the map by user click
        function click(d) {

          // if already active clicking will de-activate
          if (active === d) return reset();
            
          // clicking a second country while zoomed in will de-activate (un-highlight) the first
          g.selectAll(".active").classed("active", false);

          // highlights (fills) the country clicked
          d3.select(this).classed("active", active = d);

          var centroid = path.centroid(d);
          var x = centroid[0];
          var y = centroid[1];
          var k = 4;

          g.transition()
              .duration(1000)
              .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")");
              //.style("stroke-width", 1.5 / k + "px");
       
        }


        // zooms the map back out
        function reset() {

          console.log("in the reset");

          g.selectAll(".active").classed("active", active = false);
          g.transition().duration(750).attr("transform", "translate(0,0)");;
          g.selectAll(".town")
              .transition()
                .duration(750);
              //.style("stroke-width", ".5px");
        }


        queue()
          .defer(d3.json, "data/ne-map10pct.json")
          //.defer(d3.csv, "data/id-zip.csv")
          .defer(d3.csv, "data/test.csv")
          .await(ready);

        //function ready(error, map, zip, donation) {
        function ready(error, map, donation) {

            var zipById = {};
            var amtByZip = new Object();

            //zip.forEach(function(d) { zipById[d.id] = +d.zip.toString(); });
            //zip.forEach(function(d) { zipById[d.id] = +d.amt; });
            donation.forEach(function(d) { console.log(d.zip); amtByZip[d.zip] = +d.amt });


            /*
             * Vermont
             */
            g_vt.attr("class", "vermont")
              .selectAll("path")
                .data(topojson.feature(map, map.objects.g_vermont).features)
              .enter().append("path")
                // Adds the zip code as a class of the path
                .attr("class", function(d) { return d.properties.ZCTA5CE10 + " town"; })
                .attr("d", path)
                .style("fill", function(d, i) { return color(amtByZip[d.properties.ZCTA5CE10]); })
                .style("fill-opacity", ".5");
                //.style("fill", function(d, i) { console.log(zipById[i]); return color(zipById[i]); });

            // paints the state border
            g_vt.append("path")
                .datum(topojson.mesh(map, map.objects.g_vermont, function(a, b) { return a === b; }))
                .attr("class", "boundary")
                .attr("d", path);


            /*
             * New Hampshire
             */
            var nhTowns = topojson.feature(map, map.objects.g_nh.geometries);
            //var nhTowns = topojson.feature(map, map.objects.g_nh).geometries;

            g_nh.attr("class", "new_hamp")
              .selectAll("path")
                .data(topojson.feature(map, map.objects.g_nh).features)
              .enter().append("path")
                .attr("class", function(d) { return d.properties.ZCTA5CE10 + " town"; })
                .attr("d", path)
                .style("fill", function(d, i) { return color(amtByZip[d.properties.ZCTA5CE10]); });
                //.style("fill", function(d, i) { return color(zipById[i]); });

            // paints the state border
            g_nh.append("path")
                .datum(topojson.mesh(map, map.objects.g_nh, function(a, b) { return a === b; }))
                .attr("class", "boundary")
                .attr("d", path);


            /*
             * Maine
             */
            g_me.attr("class", "maine")
              .selectAll("path")
                .data(topojson.feature(map, map.objects.g_maine).features)
              .enter().append("path")
                // Adds the zip code as a class of the path
                .attr("class", function(d) { return d.properties.ZCTA5CE10 + " town"; })
                .attr("d", path)
                .style("fill", function(d, i) { return color(amtByZip[d.properties.ZCTA5CE10]); })
                .style("fill-opacity", ".5");

            // paints the state border
            g_me.append("path")
                .datum(topojson.mesh(map, map.objects.g_maine, function(a, b) { return a === b; }))
                .attr("class", "boundary")
                .attr("d", path);


            /*
             * Massachusetts
             */
            g_ma.attr("class", "mass")
              .selectAll("path")
                .data(topojson.feature(map, map.objects.g_mass).features)
              .enter().append("path")
                .attr("class", function(d) { return d.properties.ZCTA5CE10 + " town"; })
                .attr("d", path)
                .style("fill", function(d, i) { return color(amtByZip[d.properties.ZCTA5CE10]); })
                .style("fill-opacity", ".5");

             // paints the state border
            g_ma.append("path")
                .datum(topojson.mesh(map, map.objects.g_mass, function(a, b) { return a === b; }))
                .attr("class", "boundary")
                .attr("d", path);


            var town = g.selectAll(".town").on("click", click);

            /*
            nhTown
             .enter()
              .insert("path")
              .attr("class", function(d,i) { return d.name + " country"; })   
                .attr("title", function(d,i) { return d.name; })  // country name
                .attr("d", path)
                .on("click", click);
                */

            // Show/hide tooltip
            town
              .on("mousemove", function(d,i) {
                var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );

                tooltip
                  .classed("hidden", false)
                  .attr("style", "left:" + (mouse[0]+30) + "px;top:" + (mouse[1]-10) + "px")
                  .html(d.properties.ZCTA5CE10)
              })
              .on("mouseout",  function(d,i) {
                tooltip.classed("hidden", true)
              });

          }   

   </script>

 </body>
</html>